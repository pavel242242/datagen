{
  "version": "1.0",
  "metadata": {
    "name": "ComprehensiveFeatureTest"
  },
  "timeframe": {
    "start": "2024-01-01T00:00:00Z",
    "end": "2024-12-31T23:59:59Z",
    "freq": "H"
  },
  "nodes": [
    {
      "id": "status_vocab",
      "kind": "vocab",
      "pk": "value",
      "columns": [
        {
          "name": "value",
          "type": "string",
          "nullable": false,
          "generator": {
            "enum_list": {
              "values": ["pending", "active", "completed", "cancelled", "failed"]
            }
          },
          "comment": "Generator: enum_list for vocabulary"
        },
        {
          "name": "display_name",
          "type": "string",
          "nullable": false,
          "generator": {
            "choice": {
              "choices": ["Pending", "Active", "Completed", "Cancelled", "Failed"],
              "weights_kind": "uniform"
            }
          }
        },
        {
          "name": "sort_order",
          "type": "int",
          "nullable": false,
          "generator": {"sequence": {"start": 1, "step": 1}}
        }
      ]
    },
    {
      "id": "effect_events",
      "kind": "entity",
      "rows": 100,
      "pk": "event_id",
      "columns": [
        {
          "name": "event_id",
          "type": "int",
          "nullable": false,
          "generator": {"sequence": {"start": 1, "step": 1}}
        },
        {
          "name": "event_name",
          "type": "string",
          "nullable": false,
          "generator": {
            "choice": {
              "choices": ["Promotion", "Campaign", "Holiday", "Flash Sale"],
              "weights_kind": "uniform"
            }
          }
        },
        {
          "name": "category",
          "type": "string",
          "nullable": false,
          "generator": {
            "choice": {
              "choices": ["A", "B", "C"],
              "weights": [0.5, 0.3, 0.2]
            }
          },
          "comment": "Category for testing effect with join keys"
        },
        {
          "name": "start_time",
          "type": "datetime",
          "nullable": false,
          "generator": {
            "datetime_series": {
              "within": "timeframe",
              "freq": "D"
            }
          }
        },
        {
          "name": "end_time",
          "type": "datetime",
          "nullable": false,
          "generator": {
            "datetime_series": {
              "within": "timeframe",
              "freq": "D"
            }
          }
        },
        {
          "name": "impact_multiplier",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 1.5, "std": 0.3},
              "clamp": [0.5, 3.0]
            }
          }
        }
      ]
    },
    {
      "id": "customer",
      "kind": "entity",
      "rows": 30,
      "pk": "customer_id",
      "columns": [
        {
          "name": "customer_id",
          "type": "int",
          "nullable": false,
          "generator": {"sequence": {"start": 5000, "step": 1}}
        },
        {
          "name": "segment",
          "type": "string",
          "nullable": false,
          "generator": {
            "choice": {
              "choices": ["Premium", "Standard", "Basic"],
              "weights": [0.2, 0.5, 0.3]
            }
          }
        },
        {
          "name": "registered_at",
          "type": "datetime",
          "nullable": false,
          "generator": {
            "datetime_series": {
              "within": "timeframe",
              "freq": "D"
            }
          }
        }
      ]
    },
    {
      "id": "generators_test",
      "kind": "entity",
      "rows": 50,
      "pk": "id",
      "columns": [
        {
          "name": "id",
          "type": "int",
          "nullable": false,
          "generator": {"sequence": {"start": 1000, "step": 2}},
          "comment": "Generator: sequence with custom start/step"
        },
        {
          "name": "choice_uniform",
          "type": "string",
          "nullable": false,
          "generator": {
            "choice": {
              "choices": ["A", "B", "C", "D"],
              "weights_kind": "uniform"
            }
          },
          "comment": "Generator: choice with uniform weights"
        },
        {
          "name": "choice_zipf",
          "type": "string",
          "nullable": false,
          "generator": {
            "choice": {
              "choices": ["Common", "Uncommon", "Rare", "VeryRare", "UltraRare"],
              "weights_kind": "zipf@1.5"
            }
          },
          "comment": "Generator: choice with zipf distribution"
        },
        {
          "name": "choice_head_tail",
          "type": "string",
          "nullable": false,
          "generator": {
            "choice": {
              "choices": ["Top1", "Top2", "Top3", "Long1", "Long2", "Long3", "Long4", "Long5"],
              "weights_kind": "head_tail@{0.7,2.0}"
            }
          },
          "comment": "Generator: choice with head_tail distribution"
        },
        {
          "name": "choice_explicit",
          "type": "string",
          "nullable": false,
          "generator": {
            "choice": {
              "choices": ["Hot", "Warm", "Cold"],
              "weights": [0.6, 0.3, 0.1]
            }
          },
          "comment": "Generator: choice with explicit weights"
        },
        {
          "name": "dist_normal",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 100.0, "std": 15.0},
              "clamp": [50.0, 150.0]
            }
          },
          "comment": "Generator: normal distribution"
        },
        {
          "name": "dist_lognormal",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "lognormal",
              "params": {"mean": 3.0, "sigma": 0.5},
              "clamp": [1.0, 1000.0]
            }
          },
          "comment": "Generator: lognormal distribution"
        },
        {
          "name": "dist_uniform",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "uniform",
              "params": {"low": 0.0, "high": 100.0},
              "clamp": [0.0, 100.0]
            }
          },
          "comment": "Generator: uniform distribution"
        },
        {
          "name": "dist_poisson_like",
          "type": "int",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 10.0, "std": 3.0},
              "clamp": [0.0, 50.0]
            }
          },
          "comment": "Generator: normal distribution (int cast for poisson-like)"
        },
        {
          "name": "datetime_simple",
          "type": "datetime",
          "nullable": false,
          "generator": {
            "datetime_series": {
              "within": "timeframe",
              "freq": "D"
            }
          },
          "comment": "Generator: datetime_series without pattern"
        },
        {
          "name": "datetime_dow_pattern",
          "type": "datetime",
          "nullable": false,
          "generator": {
            "datetime_series": {
              "within": "timeframe",
              "freq": "H",
              "pattern": {
                "dimension": "dow",
                "weights": [1.0, 1.1, 1.1, 1.1, 1.0, 0.3, 0.2]
              }
            }
          },
          "comment": "Generator: datetime_series with dow pattern"
        },
        {
          "name": "datetime_composite",
          "type": "datetime",
          "nullable": false,
          "generator": {
            "datetime_series": {
              "within": "timeframe",
              "freq": "H",
              "pattern": {
                "dimension": "dow",
                "weights": [1.0, 1.1, 1.1, 1.1, 1.0, 0.3, 0.2]
              }
            }
          },
          "modifiers": [
            {
              "transform": "seasonality",
              "args": {
                "dimension": "hour",
                "weights": [0.1, 0.1, 0.1, 0.1, 0.2, 0.5, 1.0, 1.5, 1.8, 1.8, 1.5, 1.3, 1.2, 1.2, 1.3, 1.5, 1.7, 1.8, 1.6, 1.2, 0.8, 0.5, 0.3, 0.2]
              }
            },
            {
              "transform": "time_jitter",
              "args": {"std_minutes": 15}
            }
          ],
          "comment": "Generator: datetime with composite patterns (dow + hour)"
        },
        {
          "name": "faker_name",
          "type": "string",
          "nullable": false,
          "generator": {
            "faker": {
              "method": "name",
              "locale": "en_US"
            }
          },
          "comment": "Generator: faker for names"
        },
        {
          "name": "faker_email",
          "type": "string",
          "nullable": false,
          "generator": {
            "faker": {
              "method": "email",
              "locale": "en_US"
            }
          },
          "comment": "Generator: faker for emails"
        },
        {
          "name": "created_at",
          "type": "datetime",
          "nullable": false,
          "generator": {
            "datetime_series": {
              "within": "timeframe",
              "freq": "H"
            }
          }
        }
      ]
    },
    {
      "id": "modifiers_test",
      "kind": "fact",
      "parents": ["generators_test"],
      "pk": "id",
      "fanout": {"distribution": "poisson", "lambda": 3.0, "min": 1, "max": 10},
      "columns": [
        {
          "name": "id",
          "type": "int",
          "nullable": false,
          "generator": {"sequence": {"start": 10000, "step": 1}}
        },
        {
          "name": "parent_id",
          "type": "int",
          "nullable": false,
          "generator": {"lookup": {"from": "generators_test.id"}}
        },
        {
          "name": "base_value",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 50.0, "std": 10.0},
              "clamp": [0.0, 200.0]
            }
          }
        },
        {
          "name": "value_multiplied",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 100.0, "std": 20.0},
              "clamp": [0.0, 500.0]
            }
          },
          "modifiers": [
            {
              "transform": "multiply",
              "args": {"factor": 1.5}
            }
          ],
          "comment": "Modifier: multiply"
        },
        {
          "name": "value_added",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "uniform",
              "params": {"low": 0.0, "high": 50.0},
              "clamp": [0.0, 100.0]
            }
          },
          "modifiers": [
            {
              "transform": "add",
              "args": {"value": 25.0}
            }
          ],
          "comment": "Modifier: add"
        },
        {
          "name": "value_clamped",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 100.0, "std": 50.0},
              "clamp": [0.0, 1000.0]
            }
          },
          "modifiers": [
            {
              "transform": "clamp",
              "args": {"min": 60.0, "max": 140.0}
            }
          ],
          "comment": "Modifier: clamp"
        },
        {
          "name": "value_jittered",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 100.0, "std": 10.0},
              "clamp": [0.0, 500.0]
            }
          },
          "modifiers": [
            {
              "transform": "jitter",
              "args": {"std": 5.0, "mode": "add"}
            }
          ],
          "comment": "Modifier: jitter (additive)"
        },
        {
          "name": "value_jittered_mul",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 100.0, "std": 10.0},
              "clamp": [0.0, 500.0]
            }
          },
          "modifiers": [
            {
              "transform": "jitter",
              "args": {"std": 0.1, "mode": "mul"}
            }
          ],
          "comment": "Modifier: jitter (multiplicative)"
        },
        {
          "name": "status",
          "type": "string",
          "nullable": false,
          "generator": {
            "choice": {
              "choices": ["draft", "active", "inactive"],
              "weights": [0.1, 0.8, 0.1]
            }
          }
        },
        {
          "name": "status_mapped",
          "type": "string",
          "nullable": false,
          "generator": {
            "choice": {
              "choices": ["A", "B", "C"],
              "weights": [0.5, 0.3, 0.2]
            }
          },
          "modifiers": [
            {
              "transform": "map_values",
              "args": {
                "mapping": {
                  "A": "Active",
                  "B": "Blocked",
                  "C": "Closed"
                }
              }
            }
          ],
          "comment": "Modifier: map_values"
        },
        {
          "name": "timestamp",
          "type": "datetime",
          "nullable": false,
          "generator": {
            "datetime_series": {
              "within": "timeframe",
              "freq": "H",
              "pattern": {
                "dimension": "dow",
                "weights": [1.0, 1.1, 1.1, 1.1, 1.0, 0.3, 0.2]
              }
            }
          },
          "modifiers": [
            {
              "transform": "seasonality",
              "args": {
                "dimension": "hour",
                "weights": [0.2, 0.1, 0.1, 0.1, 0.2, 0.6, 1.0, 1.5, 1.8, 1.8, 1.6, 1.4, 1.3, 1.3, 1.4, 1.6, 1.8, 1.9, 1.7, 1.3, 0.9, 0.6, 0.4, 0.3]
              }
            },
            {
              "transform": "time_jitter",
              "args": {"std_minutes": 30}
            }
          ],
          "comment": "Modifier: seasonality + time_jitter on datetime"
        },
        {
          "name": "value_with_outliers",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 100.0, "std": 15.0},
              "clamp": [0.0, 500.0]
            }
          },
          "modifiers": [
            {
              "transform": "outliers",
              "args": {
                "rate": 0.05,
                "mode": "spike",
                "magnitude_dist": {
                  "type": "lognormal",
                  "params": {"mean": 1.0, "sigma": 0.5},
                  "clamp": [1.5, 5.0]
                }
              }
            }
          ],
          "comment": "Modifier: outliers (spike mode)"
        },
        {
          "name": "value_with_drops",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 100.0, "std": 15.0},
              "clamp": [0.0, 500.0]
            }
          },
          "modifiers": [
            {
              "transform": "outliers",
              "args": {
                "rate": 0.03,
                "mode": "drop",
                "magnitude_dist": {
                  "type": "uniform",
                  "params": {"low": 2.0, "high": 4.0},
                  "clamp": [2.0, 4.0]
                }
              }
            }
          ],
          "comment": "Modifier: outliers (drop mode)"
        },
        {
          "name": "value_with_effect",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 100.0, "std": 20.0},
              "clamp": [0.0, 500.0]
            }
          },
          "modifiers": [
            {
              "transform": "effect",
              "args": {
                "effect_table": "effect_events",
                "on": {},
                "window": {
                  "start_col": "start_time",
                  "end_col": "end_time"
                },
                "map": {
                  "field": "impact_multiplier",
                  "op": "mul",
                  "default": 1.0
                }
              }
            }
          ],
          "comment": "Modifier: effect (column-level)"
        }
      ],
      "modifiers": [
        {
          "transform": "effect",
          "args": {
            "effect_table": "effect_events",
            "on": {},
            "window": {
              "start_col": "start_time",
              "end_col": "end_time"
            },
            "map": {
              "field": "impact_multiplier",
              "op": "mul",
              "default": 1.0
            }
          }
        }
      ],
      "comment": "Table-level effect modifier"
    },
    {
      "id": "fanout_test",
      "kind": "fact",
      "parents": ["generators_test"],
      "pk": "id",
      "fanout": {"distribution": "uniform", "lambda": 5.0, "min": 2, "max": 8},
      "columns": [
        {
          "name": "id",
          "type": "int",
          "nullable": false,
          "generator": {"sequence": {"start": 20000, "step": 1}}
        },
        {
          "name": "parent_id",
          "type": "int",
          "nullable": false,
          "generator": {"lookup": {"from": "generators_test.id"}}
        },
        {
          "name": "value",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 50.0, "std": 10.0},
              "clamp": [0.0, 200.0]
            }
          }
        }
      ],
      "comment": "Fanout: uniform distribution"
    },
    {
      "id": "expression_test",
      "kind": "fact",
      "parents": ["modifiers_test"],
      "pk": "id",
      "fanout": {"distribution": "poisson", "lambda": 2.0, "min": 1, "max": 5},
      "columns": [
        {
          "name": "id",
          "type": "int",
          "nullable": false,
          "generator": {"sequence": {"start": 30000, "step": 1}}
        },
        {
          "name": "parent_id",
          "type": "int",
          "nullable": false,
          "generator": {"lookup": {"from": "modifiers_test.id"}}
        },
        {
          "name": "base_a",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "uniform",
              "params": {"low": 10.0, "high": 50.0},
              "clamp": [10.0, 50.0]
            }
          }
        },
        {
          "name": "base_b",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "uniform",
              "params": {"low": 5.0, "high": 20.0},
              "clamp": [5.0, 20.0]
            }
          }
        },
        {
          "name": "computed_sum",
          "type": "float",
          "nullable": false,
          "generator": {
            "expression": {
              "code": "base_a + base_b"
            }
          },
          "comment": "Generator: expression (addition)"
        },
        {
          "name": "computed_product",
          "type": "float",
          "nullable": false,
          "generator": {
            "expression": {
              "code": "base_a * base_b"
            }
          },
          "comment": "Generator: expression (multiplication)"
        },
        {
          "name": "computed_complex",
          "type": "float",
          "nullable": false,
          "generator": {
            "expression": {
              "code": "(base_a + base_b) / 2.0"
            }
          },
          "comment": "Generator: expression (average)"
        }
      ]
    },
    {
      "id": "multi_parent_test",
      "kind": "fact",
      "parents": ["generators_test", "customer"],
      "pk": "id",
      "fanout": {"distribution": "poisson", "lambda": 2.5, "min": 1, "max": 8},
      "columns": [
        {
          "name": "id",
          "type": "int",
          "nullable": false,
          "generator": {"sequence": {"start": 40000, "step": 1}}
        },
        {
          "name": "generator_id",
          "type": "int",
          "nullable": false,
          "generator": {"lookup": {"from": "generators_test.id"}},
          "comment": "FK to first parent"
        },
        {
          "name": "customer_id",
          "type": "int",
          "nullable": false,
          "generator": {"lookup": {"from": "customer.customer_id"}},
          "comment": "FK to second parent"
        },
        {
          "name": "category",
          "type": "string",
          "nullable": false,
          "generator": {
            "choice": {
              "choices": ["A", "B", "C"],
              "weights": [0.4, 0.4, 0.2]
            }
          },
          "comment": "Category field for join-based effect"
        },
        {
          "name": "amount",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 100.0, "std": 25.0},
              "clamp": [10.0, 500.0]
            }
          }
        },
        {
          "name": "amount_with_keyed_effect",
          "type": "float",
          "nullable": false,
          "generator": {
            "distribution": {
              "type": "normal",
              "params": {"mean": 200.0, "std": 40.0},
              "clamp": [20.0, 800.0]
            }
          },
          "modifiers": [
            {
              "transform": "effect",
              "args": {
                "effect_table": "effect_events",
                "on": {"category": "category"},
                "window": {
                  "start_col": "start_time",
                  "end_col": "end_time"
                },
                "map": {
                  "field": "impact_multiplier",
                  "op": "mul",
                  "default": 1.0
                }
              }
            }
          ],
          "comment": "Modifier: effect with join keys (on clause)"
        },
        {
          "name": "timestamp",
          "type": "datetime",
          "nullable": false,
          "generator": {
            "datetime_series": {
              "within": "timeframe",
              "freq": "H"
            }
          }
        }
      ],
      "comment": "Tests multiple parents (generators_test + customer) and effect with join keys"
    }
  ],
  "constraints": {
    "unique": [
      "status_vocab.value",
      "customer.customer_id",
      "generators_test.id",
      "modifiers_test.id",
      "fanout_test.id",
      "expression_test.id",
      "multi_parent_test.id",
      "effect_events.event_id"
    ],
    "foreign_keys": [
      {"from": "modifiers_test.parent_id", "to": "generators_test.id"},
      {"from": "fanout_test.parent_id", "to": "generators_test.id"},
      {"from": "expression_test.parent_id", "to": "modifiers_test.id"},
      {"from": "multi_parent_test.generator_id", "to": "generators_test.id"},
      {"from": "multi_parent_test.customer_id", "to": "customer.customer_id"}
    ],
    "ranges": [
      {"attr": "generators_test.dist_normal", "min": 50.0, "max": 150.0},
      {"attr": "modifiers_test.value_clamped", "min": 60.0, "max": 140.0}
    ],
    "inequalities": [
      {"left": "effect_events.start_time", "op": "<=", "right": "effect_events.end_time"}
    ]
  },
  "targets": {
    "weekend_share": {
      "table": "modifiers_test",
      "timestamp": "timestamp",
      "min": 0.05,
      "max": 0.25
    },
    "mean_in_range": {
      "table": "modifiers_test",
      "column": "value_multiplied",
      "min": 120.0,
      "max": 180.0
    },
    "composite_effect": {
      "table": "modifiers_test",
      "metric": "occurrence_rate",
      "influences": [
        {
          "kind": "seasonality",
          "dimension": "dow",
          "weights": [1.0, 1.1, 1.1, 1.1, 1.0, 0.3, 0.2]
        },
        {
          "kind": "seasonality",
          "dimension": "hour",
          "weights": [0.2, 0.1, 0.1, 0.1, 0.2, 0.6, 1.0, 1.5, 1.8, 1.8, 1.6, 1.4, 1.3, 1.3, 1.4, 1.6, 1.8, 1.9, 1.7, 1.3, 0.9, 0.6, 0.4, 0.3]
        }
      ],
      "tolerance": {"mae": 0.05, "mape": 15.0}
    }
  }
}
